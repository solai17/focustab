// FocusTab Database Schema v3.0
// "Curated Wisdom" - Pivot to curated newsletter insights
// Docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// USER MODELS
// =============================================================================

model User {
  id                    String    @id @default(uuid())
  email                 String    @unique
  googleId              String?   @unique // Google account ID for Chrome Identity
  passwordHash          String    // Empty string for Google-only accounts
  name                  String
  birthDate             DateTime?  // Nullable for incomplete onboarding
  lifeExpectancy        Int       @default(80)

  // DEPRECATED: Individual inbox emails removed in v3.0
  // Keeping field for migration compatibility, will be empty for new users
  inboxEmail            String?   @unique

  // Admin & Personalization
  isAdmin               Boolean   @default(false) // Admin access for moderation
  enableRecommendations Boolean   @default(true)  // Show curated content
  onboardingCompleted   Boolean   @default(false)

  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  // Relations
  subscriptions         UserSubscription[]
  engagements           UserEngagement[]
  contentHistory        ContentHistory[]
  preferences           UserPreference[]

  @@index([googleId])
  @@index([isAdmin])
  @@map("users")
}

// User's subscription to a newsletter source
model UserSubscription {
  id              String    @id @default(uuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  sourceId        String
  source          NewsletterSource @relation(fields: [sourceId], references: [id], onDelete: Cascade)

  subscribedAt    DateTime  @default(now())
  isActive        Boolean   @default(true)

  // Track how user discovered this source
  discoveryMethod String    @default("forwarded") // forwarded, recommended, search

  @@unique([userId, sourceId])
  @@index([userId])
  @@index([sourceId])
  @@map("user_subscriptions")
}

// User's engagement with a content byte (votes, saves, etc.)
model UserEngagement {
  id              String    @id @default(uuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  byteId          String
  byte            ContentByte @relation(fields: [byteId], references: [id], onDelete: Cascade)

  vote            Int       @default(0) // +1 upvote, -1 downvote, 0 neutral
  isSaved         Boolean   @default(false)
  isShared        Boolean   @default(false)

  // Implicit engagement
  viewCount       Int       @default(0)
  totalDwellTimeMs Int      @default(0) // Total time spent viewing

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([userId, byteId])
  @@index([userId])
  @@index([byteId])
  @@index([vote])
  @@map("user_engagements")
}

// Track what content user has seen (for feed deduplication)
model ContentHistory {
  id              String    @id @default(uuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  byteId          String
  byte            ContentByte @relation(fields: [byteId], references: [id], onDelete: Cascade)

  shownAt         DateTime  @default(now())
  dwellTimeMs     Int?      // How long user viewed this byte
  isRead          Boolean   @default(false) // True if user actually read (tab active for 5+ seconds)

  @@unique([userId, byteId])
  @@index([userId])
  @@index([shownAt])
  @@index([isRead])
  @@map("content_history")
}

// User's category preferences for personalization
model UserPreference {
  id              String    @id @default(uuid())
  userId          String
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  category        String    // productivity, wisdom, business, tech, etc.
  weight          Float     @default(0.5) // 0.0 to 1.0, learned from engagement

  updatedAt       DateTime  @updatedAt

  @@unique([userId, category])
  @@index([userId])
  @@map("user_preferences")
}

// =============================================================================
// CONTENT MODELS (Shared across users)
// =============================================================================

// Newsletter source (e.g., "Lenny's Newsletter", "Stratechery")
model NewsletterSource {
  id              String    @id @default(uuid())

  name            String    // Display name
  senderEmail     String    @unique // Primary identifier
  senderDomain    String    // Extracted domain for grouping
  description     String?   // Auto-generated or manual
  website         String?   // Newsletter subscription URL
  logoUrl         String?   // Newsletter logo/avatar URL

  // Categorization
  category        String    @default("general") // tech, business, productivity, etc.
  tags            String[]  @default([])

  // Curation & Scraping
  isCurated       Boolean   @default(false) // Admin-curated source (shown to users)
  archiveUrl      String?   // URL to scrape newsletter archives from
  scrapingEnabled Boolean   @default(false) // Whether auto-scraping is enabled
  lastScrapedAt   DateTime? // When last scrape completed
  lastScrapeStatus String?  // success, failed, partial
  lastScrapeError String?   // Error message if failed
  scrapeFrequency String    @default("daily") // daily, weekly, manual

  // Aggregate stats (updated periodically)
  subscriberCount Int       @default(0) // Users subscribed to this source
  totalEditions   Int       @default(0) // Total editions scraped
  totalInsights   Int       @default(0) // Total insights extracted
  avgEngagementScore Float  @default(0)

  // Verification & Monetization
  isVerified      Boolean   @default(false) // Verified content creator
  isSponsored     Boolean   @default(false) // Paid placement
  sponsorTier     String?   // bronze, silver, gold, etc.

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  editions        Edition[]
  subscriptions   UserSubscription[]

  @@index([category])
  @@index([isCurated])
  @@index([isVerified])
  @@index([avgEngagementScore])
  @@index([scrapingEnabled])
  @@map("newsletter_sources")
}

// Individual newsletter issue/edition
model Edition {
  id              String    @id @default(uuid())
  sourceId        String
  source          NewsletterSource @relation(fields: [sourceId], references: [id], onDelete: Cascade)

  subject         String
  contentHash     String    @unique // For deduplication
  rawContent      String    // Original HTML
  textContent     String    // Extracted plain text

  // AI-processed summary
  summary         String?
  readTimeMinutes Int?

  // Processing queue status
  processingStatus String   @default("pending") // pending, processing, completed, failed
  processAttempts  Int      @default(0)         // Number of processing attempts
  processingError  String?                      // Last error message if failed
  processedByModel String?                      // Which AI model processed this (e.g., "gemini-3-flash", "claude-sonnet-4")
  isProcessed      Boolean  @default(false)     // Legacy field for compatibility

  publishedAt     DateTime  @default(now()) // When newsletter was sent
  receivedAt      DateTime  @default(now()) // When we received it
  processedAt     DateTime?

  // Relations
  bytes           ContentByte[]

  @@index([sourceId])
  @@index([publishedAt])
  @@index([contentHash])
  @@index([processingStatus])  // Index for queue queries
  @@map("editions")
}

// Individual bite-sized content extracted from newsletters
model ContentByte {
  id              String    @id @default(uuid())
  editionId       String
  edition         Edition   @relation(fields: [editionId], references: [id], onDelete: Cascade)

  // The actual content
  content         String    // The quote, insight, or takeaway
  type            String    @default("insight") // quote, insight, statistic, action, takeaway

  // Attribution
  author          String?   // Original author if different from newsletter
  context         String?   // Brief context about where this came from

  // Categorization
  category        String    @default("wisdom") // wisdom, productivity, business, tech, life, etc.
  tags            String[]  @default([])

  // Engagement metrics (aggregate, updated periodically)
  upvotes         Int       @default(0)
  downvotes       Int       @default(0)
  viewCount       Int       @default(0)
  saveCount       Int       @default(0)
  shareCount      Int       @default(0)

  // Calculated scores
  engagementScore Float     @default(0) // Weighted engagement
  trendingScore   Float     @default(0) // Time-decayed engagement
  qualityScore    Float     @default(0) // AI-assessed quality (0-1)

  // Moderation
  moderationStatus String   @default("pending") // pending, approved, rejected, flagged
  moderatedBy     String?   // Admin user ID who moderated
  moderatedAt     DateTime? // When moderation happened
  rejectionReason String?   // Why it was rejected (for audit)

  // For sponsored content
  isSponsored     Boolean   @default(false)
  sponsorId       String?   // Reference to sponsor/creator

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  engagements     UserEngagement[]
  history         ContentHistory[]

  @@index([editionId])
  @@index([type])
  @@index([category])
  @@index([engagementScore])
  @@index([trendingScore])
  @@index([createdAt])
  @@index([isSponsored])
  @@index([moderationStatus])
  @@index([qualityScore])
  @@map("content_bytes")
}

// =============================================================================
// ADMIN MODELS
// =============================================================================

// Forwarded emails pending admin review (from inbox@byteletters.app)
model ForwardedEmail {
  id              String    @id @default(uuid())

  // Email metadata
  fromEmail       String    // Original sender
  fromName        String?   // Sender display name
  subject         String
  contentHash     String    @unique // For deduplication

  // Raw content
  htmlContent     String?   // Original HTML
  textContent     String    // Plain text version

  // Processing status
  status          String    @default("pending") // pending, approved, rejected, processing
  reviewedBy      String?   // Admin user ID
  reviewedAt      DateTime?
  reviewNotes     String?   // Admin notes

  // If approved, links to created source
  createdSourceId String?   // Newsletter source created from this

  receivedAt      DateTime  @default(now())
  createdAt       DateTime  @default(now())

  @@index([status])
  @@index([fromEmail])
  @@index([receivedAt])
  @@map("forwarded_emails")
}

// Scraping job logs for monitoring
model ScrapeJob {
  id              String    @id @default(uuid())
  sourceId        String

  // Job details
  status          String    @default("running") // running, completed, failed
  startedAt       DateTime  @default(now())
  completedAt     DateTime?

  // Results
  editionsFound   Int       @default(0)
  editionsNew     Int       @default(0)
  editionsSkipped Int       @default(0)
  insightsCreated Int       @default(0)

  // Error tracking
  errorMessage    String?
  errorStack      String?

  // Triggered by
  triggeredBy     String    @default("manual") // manual, scheduled, admin
  adminUserId     String?   // If triggered by admin

  @@index([sourceId])
  @@index([status])
  @@index([startedAt])
  @@map("scrape_jobs")
}

